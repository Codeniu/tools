<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ‹¼æ¥å·¥å…· - Image Merger</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼è¡¥å…… */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .upload-area {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #fff;
        }

        .upload-area.dragover .upload-text {
            color: white;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ç”»å¸ƒå®¹å™¨ */
        #canvasContainer {
            position: relative;
            overflow: auto;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 19px,
                #e5e7eb 19px,
                #e5e7eb 20px
            ),
            repeating-linear-gradient(
                90deg,
                transparent,
                transparent 19px,
                #e5e7eb 19px,
                #e5e7eb 20px
            );
            background-size: 20px 20px;
            background-position: -1px -1px;
            background-color: #f9fafb;
        }

        /* ç”»å¸ƒ */
        #editorCanvas {
            display: block;
            cursor: crosshair;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-6">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">ğŸ”— å›¾ç‰‡æ‹¼æ¥å·¥å…·</h1>
            <p class="text-gray-600 text-sm md:text-base">æ™ºèƒ½å¸ƒå±€æ¨¡å¼ - è‡ªç”±æ‹–æ‹½ã€ç¼©æ”¾ã€æ—‹è½¬å›¾ç‰‡</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- å·¦ä¾§ï¼šè®¾ç½®é¢æ¿ -->
            <div class="lg:col-span-1 space-y-4">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area border-3 border-dashed border-indigo-500 rounded-xl p-4 text-center cursor-pointer"
                     id="uploadSection">
                    <div class="text-3xl mb-1">ğŸ“</div>
                    <div class="upload-text text-gray-700 font-medium text-sm">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                    <div class="text-gray-500 text-xs mt-1">æ”¯æŒå¤šé€‰</div>
                    <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                </div>

                <!-- ç”»å¸ƒè®¾ç½® -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3">âš™ï¸ ç”»å¸ƒè®¾ç½®</h3>

                    <div class="space-y-3">
                        <!-- å¸¸ç”¨å°ºå¯¸é¢„è®¾ -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">å¸¸ç”¨å°ºå¯¸</label>
                            <select id="presetSize" class="w-full px-2 py-2 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <option value="">è‡ªå®šä¹‰å°ºå¯¸</option>
                                <option value="1920x1080" selected>1920Ã—1080 (Full HD)</option>
                                <option value="1080x1080">1080Ã—1080 (Instagram æ–¹å½¢)</option>
                                <option value="1080x1920">1080Ã—1920 (Instagram ç«–ç‰ˆ)</option>
                                <option value="1080x1350">1080Ã—1350 (Instagram æ¨ªç‰ˆ)</option>
                                <option value="1280x720">1280Ã—720 (HD)</option>
                                <option value="2560x1440">2560Ã—1440 (2K)</option>
                                <option value="3840x2160">3840Ã—2160 (4K)</option>
                                <option value="800x600">800Ã—600 (SVGA)</option>
                                <option value="1024x768">1024Ã—768 (XGA)</option>
                            </select>
                        </div>

                        <!-- ç”»å¸ƒå°ºå¯¸ -->
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">å®½åº¦</label>
                                <input type="number" id="canvasWidth" value="1920"
                                       class="w-full px-2 py-1 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">é«˜åº¦</label>
                                <input type="number" id="canvasHeight" value="1080"
                                       class="w-full px-2 py-1 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- èƒŒæ™¯é¢œè‰² -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">èƒŒæ™¯é¢œè‰²</label>
                            <div class="flex gap-2 items-center">
                                <input type="color" id="bgColorInput" value="#ffffff"
                                       class="w-12 h-10 rounded cursor-pointer border-2 border-gray-300">
                                <input type="text" id="bgColorText" value="#ffffff"
                                       class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                <label class="flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" id="transparentBg" class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                    <span class="text-xs font-medium text-gray-600">é€æ˜</span>
                                </label>
                            </div>
                        </div>

                        <!-- è¾…åŠ©åŠŸèƒ½ -->
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="showGrid" checked class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="text-xs font-medium text-gray-600">æ˜¾ç¤ºç½‘æ ¼çº¿</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="snapToGrid" checked class="w-4 h-4 text-indigo-600 rounded focus:ring-2 focus:ring-indigo-500">
                                <span class="text-xs font-medium text-gray-600">å¯ç”¨ç½‘æ ¼å¸é™„ï¼ˆ20pxï¼‰</span>
                            </label>
                        </div>

                        <!-- ç”»å¸ƒæ“ä½œ -->
                        <div class="flex gap-2 pt-2">
                            <button id="applyCanvasBtn"
                                    class="flex-1 bg-indigo-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-indigo-600 transition-all text-sm">
                                åº”ç”¨è®¾ç½®
                            </button>
                            <button id="resetCanvasBtn"
                                    class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-all text-sm">
                                é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- è¾“å‡ºæ ¼å¼ -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3">ğŸ“¤ å¯¼å‡ºè®¾ç½®</h3>

                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-2">è¾“å‡ºæ ¼å¼</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="relative flex cursor-pointer">
                                <input type="radio" name="format" value="png" checked class="peer sr-only">
                                <div class="w-full px-2 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                    PNG
                                </div>
                            </label>
                            <label class="relative flex cursor-pointer">
                                <input type="radio" name="format" value="jpeg" class="peer sr-only">
                                <div class="w-full px-2 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                    JPEG
                                </div>
                            </label>
                            <label class="relative flex cursor-pointer">
                                <input type="radio" name="format" value="webp" class="peer sr-only">
                                <div class="w-full px-2 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                    WebP
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- é€‰ä¸­å›¾ç‰‡å±æ€§é¢æ¿ -->
                <div id="imagePropertiesPanel" class="bg-blue-50 rounded-xl p-4 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-blue-700">ğŸ–¼ï¸ å›¾ç‰‡å±æ€§</h3>
                        <button id="deleteSelectedBtn" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">
                            åˆ é™¤
                        </button>
                    </div>

                    <div class="space-y-2 text-xs">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-gray-600 mb-1">X ä½ç½®</label>
                                <input type="number" id="propX" class="w-full px-2 py-1 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-gray-600 mb-1">Y ä½ç½®</label>
                                <input type="number" id="propY" class="w-full px-2 py-1 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-gray-600 mb-1">å®½åº¦</label>
                                <input type="number" id="propWidth" class="w-full px-2 py-1 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-gray-600 mb-1">é«˜åº¦</label>
                                <input type="number" id="propHeight" class="w-full px-2 py-1 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-600 mb-1">æ—‹è½¬è§’åº¦: <span id="rotationValue">0</span>Â°</label>
                            <input type="range" id="propRotation" value="0" min="0" max="360"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div>
                            <label class="block text-gray-600 mb-1">ç¼©æ”¾æ¯”ä¾‹: <span id="scaleValue">100</span>%</label>
                            <input type="range" id="propScale" value="100" min="10" max="300"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div class="flex gap-2 pt-2">
                            <button id="bringFrontBtn" class="flex-1 bg-gray-200 text-gray-700 py-1 px-2 rounded hover:bg-gray-300">
                                ç½®é¡¶
                            </button>
                            <button id="sendBackBtn" class="flex-1 bg-gray-200 text-gray-700 py-1 px-2 rounded hover:bg-gray-300">
                                ç½®åº•
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="space-y-2">
                    <button id="clearBtn"
                            class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-all">
                        æ¸…ç©ºç”»å¸ƒ
                    </button>
                    <button id="downloadBtn" disabled
                            class="w-full bg-green-500 text-white py-2 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h4"></path>
                        </svg>
                        ä¸‹è½½ç»“æœ
                    </button>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div id="statsSection" class="bg-gray-50 rounded-xl p-4 hidden">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                    <div class="space-y-1 text-xs text-gray-600">
                        <div class="flex justify-between">
                            <span>å›¾ç‰‡æ•°é‡ï¼š</span>
                            <span id="totalImages" class="font-medium">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›¾ç‰‡åˆ—è¡¨å’Œç”»å¸ƒ -->
            <div class="lg:col-span-3 space-y-4">
                <!-- å›¾ç‰‡åˆ—è¡¨ -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-indigo-600">ğŸ“· å›¾ç‰‡åˆ—è¡¨</h3>
                        <span id="imageCountBadge" class="text-sm text-gray-500">0 å¼ å›¾ç‰‡</span>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="emptyState" class="flex flex-col items-center justify-center h-32 text-gray-400">
                        <div class="text-4xl mb-2">ğŸ“·</div>
                        <p class="text-sm">è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹</p>
                    </div>

                    <!-- å›¾ç‰‡ç½‘æ ¼ -->
                    <div id="imagesList" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto hidden"></div>
                </div>

                <!-- ç”»å¸ƒåŒºåŸŸ -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-indigo-600">ğŸ¨ ç”»å¸ƒ</h3>
                        <div class="flex gap-2">
                            <button id="zoomOutBtn" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                âˆ’
                            </button>
                            <span id="zoomLevel" class="text-sm text-gray-600 px-2">100%</span>
                            <button id="zoomInBtn" class="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                +
                            </button>
                            <button id="fitToScreenBtn" class="text-sm bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600">
                                é€‚åº”å±å¹•
                            </button>
                        </div>
                    </div>

                    <div id="canvasContainer" class="rounded-lg overflow-auto p-4" style="height: 600px;">
                        <canvas id="editorCanvas"></canvas>
                    </div>

                    <div class="mt-2 text-xs text-gray-500">
                        æç¤ºï¼šæ‹–æ‹½å›¾ç‰‡ç§»åŠ¨ä½ç½® â€¢ æ‹–æ‹½è§’è½è°ƒæ•´å¤§å° â€¢ ç‚¹å‡»é€‰ä¸­ç¼–è¾‘å±æ€§ â€¢ Deleteé”®åˆ é™¤é€‰ä¸­å›¾ç‰‡
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast hidden"></div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let uploadedImages = [];
        let selectedImageId = null;
        let canvasZoom = 1;

        // æ‹–æ‹½çŠ¶æ€
        let isDragging = false;
        let isResizing = false;
        let dragStart = { x: 0, y: 0 };
        let resizeHandle = null;

        // ç”»å¸ƒè®¾ç½®
        const GRID_SIZE = 20;
        let canvasSettings = {
            width: 1920,
            height: 1080,
            bgColor: '#ffffff',
            transparent: false,
            showGrid: true,
            snapToGrid: true
        };

        // ==================== DOM å…ƒç´  ====================
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const emptyState = document.getElementById('emptyState');
        const imagesList = document.getElementById('imagesList');
        const imageCountBadge = document.getElementById('imageCountBadge');
        const canvas = document.getElementById('editorCanvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvasContainer');
        const statsSection = document.getElementById('statsSection');
        const totalImagesEl = document.getElementById('totalImages');
        const imagePropertiesPanel = document.getElementById('imagePropertiesPanel');

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            setupCanvas();
            setupEventListeners();
            render();
        }

        function setupCanvas() {
            canvas.width = canvasSettings.width;
            canvas.height = canvasSettings.height;
            fitCanvasToScreen();
        }

        function fitCanvasToScreen() {
            const containerWidth = canvasContainer.clientWidth - 32; // å‡å» padding (16px * 2)
            const containerHeight = canvasContainer.clientHeight - 32; // å‡å» padding (16px * 2)

            const scaleX = containerWidth / canvas.width;
            const scaleY = containerHeight / canvas.height;
            canvasZoom = Math.min(scaleX, scaleY, 1);

            canvas.style.width = (canvas.width * canvasZoom) + 'px';
            canvas.style.height = (canvas.height * canvasZoom) + 'px';
            document.getElementById('zoomLevel').textContent = Math.round(canvasZoom * 100) + '%';
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================
        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            uploadSection.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            // æ‹–æ‹½ä¸Šä¼ 
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });
            uploadSection.addEventListener('dragleave', () => {
                uploadSection.classList.remove('dragover');
            });
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // èƒŒæ™¯é¢œè‰²åŒæ­¥
            document.getElementById('bgColorInput').addEventListener('input', (e) => {
                document.getElementById('bgColorText').value = e.target.value;
                document.getElementById('transparentBg').checked = false;
                canvasSettings.bgColor = e.target.value;
                canvasSettings.transparent = false;
                render();
            });
            document.getElementById('bgColorText').addEventListener('input', (e) => {
                if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                    document.getElementById('bgColorInput').value = e.target.value;
                    document.getElementById('transparentBg').checked = false;
                    canvasSettings.bgColor = e.target.value;
                    canvasSettings.transparent = false;
                    render();
                }
            });

            // é€æ˜èƒŒæ™¯åˆ‡æ¢
            document.getElementById('transparentBg').addEventListener('change', (e) => {
                canvasSettings.transparent = e.target.checked;
                if (e.target.checked) {
                    // ç¦ç”¨é¢œè‰²é€‰æ‹©å™¨
                    document.getElementById('bgColorInput').disabled = true;
                    document.getElementById('bgColorText').disabled = true;
                } else {
                    // å¯ç”¨é¢œè‰²é€‰æ‹©å™¨
                    document.getElementById('bgColorInput').disabled = false;
                    document.getElementById('bgColorText').disabled = false;
                    canvasSettings.bgColor = document.getElementById('bgColorInput').value;
                }
                render();
            });

            // é¢„è®¾å°ºå¯¸é€‰æ‹©
            document.getElementById('presetSize').addEventListener('change', (e) => {
                const value = e.target.value;
                if (value) {
                    const [width, height] = value.split('x').map(Number);
                    document.getElementById('canvasWidth').value = width;
                    document.getElementById('canvasHeight').value = height;
                }
            });

            // å°ºå¯¸è¾“å…¥æ¡†å˜åŒ–æ—¶é‡ç½®é¢„è®¾é€‰æ‹©
            document.getElementById('canvasWidth').addEventListener('input', () => {
                document.getElementById('presetSize').value = '';
            });
            document.getElementById('canvasHeight').addEventListener('input', () => {
                document.getElementById('presetSize').value = '';
            });

            // ç½‘æ ¼æ˜¾ç¤ºå’Œå¸é™„
            document.getElementById('showGrid').addEventListener('change', (e) => {
                canvasSettings.showGrid = e.target.checked;
                render();
            });
            document.getElementById('snapToGrid').addEventListener('change', (e) => {
                canvasSettings.snapToGrid = e.target.checked;
            });

            // ç”»å¸ƒè®¾ç½®
            document.getElementById('applyCanvasBtn').addEventListener('click', applyCanvasSettings);
            document.getElementById('resetCanvasBtn').addEventListener('click', resetCanvas);

            // ç¼©æ”¾æ§åˆ¶
            document.getElementById('zoomInBtn').addEventListener('click', () => setZoom(canvasZoom + 0.1));
            document.getElementById('zoomOutBtn').addEventListener('click', () => setZoom(canvasZoom - 0.1));
            document.getElementById('fitToScreenBtn').addEventListener('click', fitCanvasToScreen);

            // æ¸…ç©ºå’Œä¸‹è½½
            document.getElementById('clearBtn').addEventListener('click', clearAll);
            document.getElementById('downloadBtn').addEventListener('click', downloadResult);

            // ç”»å¸ƒäº¤äº’
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp);

            // é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    if (selectedImageId && document.activeElement.tagName !== 'INPUT') {
                        deleteSelectedImage();
                    }
                }
            });

            // å±æ€§é¢æ¿
            document.getElementById('deleteSelectedBtn').addEventListener('click', deleteSelectedImage);
            document.getElementById('propX').addEventListener('input', updateSelectedImageFromProps);
            document.getElementById('propY').addEventListener('input', updateSelectedImageFromProps);
            document.getElementById('propWidth').addEventListener('input', updateSelectedImageFromProps);
            document.getElementById('propHeight').addEventListener('input', updateSelectedImageFromProps);
            document.getElementById('propRotation').addEventListener('input', (e) => {
                document.getElementById('rotationValue').textContent = e.target.value;
                updateSelectedImageFromProps();
            });
            document.getElementById('propScale').addEventListener('input', (e) => {
                document.getElementById('scaleValue').textContent = e.target.value;
                updateSelectedImageFromProps();
            });
            document.getElementById('bringFrontBtn').addEventListener('click', () => changeImageOrder('front'));
            document.getElementById('sendBackBtn').addEventListener('click', () => changeImageOrder('back'));

            // çª—å£å¤§å°æ”¹å˜
            window.addEventListener('resize', fitCanvasToScreen);
        }

        // ==================== æ–‡ä»¶å¤„ç† ====================
        function handleFiles(files) {
            if (!files || files.length === 0) return;

            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

            if (validFiles.length === 0) {
                showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            showToast(`æ­£åœ¨å¤„ç† ${validFiles.length} å¼ å›¾ç‰‡...`);

            let processedCount = 0;
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const imageObj = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            element: img,
                            x: 50,
                            y: 50,
                            width: img.width,
                            height: img.height,
                            originalWidth: img.width,
                            originalHeight: img.height,
                            rotation: 0,
                            scale: 1
                        };

                        // è‡ªåŠ¨è°ƒæ•´ä½ç½®ï¼Œé¿å…é‡å 
                        if (uploadedImages.length > 0) {
                            const lastImage = uploadedImages[uploadedImages.length - 1];
                            imageObj.x = lastImage.x + 50;
                            imageObj.y = lastImage.y + 50;

                            // ç½‘æ ¼å¸é™„
                            if (canvasSettings.snapToGrid) {
                                imageObj.x = Math.round(imageObj.x / GRID_SIZE) * GRID_SIZE;
                                imageObj.y = Math.round(imageObj.y / GRID_SIZE) * GRID_SIZE;
                            }
                        }

                        uploadedImages.push(imageObj);

                        processedCount++;
                        if (processedCount === validFiles.length) {
                            updateImagesList();
                            render();
                            showToast(`æˆåŠŸæ·»åŠ  ${validFiles.length} å¼ å›¾ç‰‡`);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateImagesList() {
            if (uploadedImages.length === 0) {
                emptyState.classList.remove('hidden');
                imagesList.classList.add('hidden');
                statsSection.classList.add('hidden');
                document.getElementById('downloadBtn').disabled = true;
                return;
            }

            emptyState.classList.add('hidden');
            imagesList.classList.remove('hidden');
            imageCountBadge.textContent = `${uploadedImages.length} å¼ å›¾ç‰‡`;
            statsSection.classList.remove('hidden');
            totalImagesEl.textContent = uploadedImages.length;
            document.getElementById('downloadBtn').disabled = false;

            imagesList.innerHTML = '';

            uploadedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = `relative cursor-pointer rounded-lg overflow-hidden border-2 transition-all ${
                    image.id === selectedImageId ? 'border-indigo-500' : 'border-transparent hover:border-gray-300'
                }`;
                item.style.width = '80px';
                item.style.height = '80px';

                const canvas = document.createElement('canvas');
                canvas.width = 80;
                canvas.height = 80;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image.element, 0, 0, 80, 80);

                item.appendChild(canvas);

                const badge = document.createElement('div');
                badge.className = 'absolute top-1 left-1 bg-gray-800 text-white text-xs px-1.5 py-0.5 rounded font-medium';
                badge.textContent = index + 1;
                item.appendChild(badge);

                item.addEventListener('click', () => selectImage(image.id));

                imagesList.appendChild(item);
            });
        }

        // ==================== ç”»å¸ƒæ¸²æŸ“ ====================
        function render() {
            // æ¸…ç©ºç”»å¸ƒ
            if (canvasSettings.transparent) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = canvasSettings.bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // ç»˜åˆ¶ç½‘æ ¼
            if (canvasSettings.showGrid) {
                drawGrid();
            }

            // ç»˜åˆ¶æ‰€æœ‰å›¾ç‰‡
            uploadedImages.forEach(image => {
                drawImage(image);
            });

            // ç»˜åˆ¶é€‰ä¸­æ¡†
            if (selectedImageId) {
                const image = uploadedImages.find(img => img.id === selectedImageId);
                if (image) {
                    drawSelectionBox(image);
                }
            }
        }

        function drawImage(image) {
            ctx.save();

            // è®¡ç®—å˜æ¢åçš„å®é™…å°ºå¯¸å’Œä½ç½®
            const actualWidth = image.width * image.scale;
            const actualHeight = image.height * image.scale;
            const centerX = image.x + actualWidth / 2;
            const centerY = image.y + actualHeight / 2;

            // åº”ç”¨å˜æ¢
            ctx.translate(centerX, centerY);
            ctx.rotate((image.rotation * Math.PI) / 180);
            ctx.scale(image.scale, image.scale);

            // ç»˜åˆ¶å›¾ç‰‡ï¼ˆå±…ä¸­ç»˜åˆ¶ï¼‰
            ctx.drawImage(
                image.element,
                -image.width / 2,
                -image.height / 2,
                image.width,
                image.height
            );

            ctx.restore();
        }

        function drawGrid() {
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 0.5;

            // å‚ç›´çº¿
            for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }

            // æ°´å¹³çº¿
            for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function drawSelectionBox(image) {
            ctx.save();

            // è®¡ç®—å˜æ¢åçš„å®é™…å°ºå¯¸å’Œä½ç½®
            const actualWidth = image.width * image.scale;
            const actualHeight = image.height * image.scale;
            const centerX = image.x + actualWidth / 2;
            const centerY = image.y + actualHeight / 2;

            // åº”ç”¨ç›¸åŒçš„å˜æ¢
            ctx.translate(centerX, centerY);
            ctx.rotate((image.rotation * Math.PI) / 180);
            ctx.scale(image.scale, image.scale);

            // ç»˜åˆ¶è¾¹æ¡†ï¼ˆåœ¨åŸå§‹å°ºå¯¸åæ ‡ç³»ä¸­ï¼‰
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2 / image.scale;
            ctx.strokeRect(
                -image.width / 2,
                -image.height / 2,
                image.width,
                image.height
            );

            // ç»˜åˆ¶æ§åˆ¶ç‚¹ï¼ˆå›ºå®šè§†è§‰å¤§å°ï¼‰
            const baseHandleSize = 8; // åŸºç¡€å¤§å°
            const handleSize = baseHandleSize / image.scale; // åå‘ç¼©æ”¾ä»¥ä¿æŒè§†è§‰å¤§å°ä¸€è‡´
            ctx.fillStyle = '#fff';

            const handles = [
                { x: -image.width / 2, y: -image.height / 2 }, // å·¦ä¸Š
                { x: image.width / 2, y: -image.height / 2 },  // å³ä¸Š
                { x: -image.width / 2, y: image.height / 2 },  // å·¦ä¸‹
                { x: image.width / 2, y: image.height / 2 }    // å³ä¸‹
            ];

            handles.forEach(handle => {
                ctx.beginPath();
                ctx.arc(handle.x, handle.y, handleSize, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            });

            ctx.restore();
        }

        // ==================== é¼ æ ‡äº¤äº’ ====================
        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) / canvasZoom,
                y: (e.clientY - rect.top) / canvasZoom
            };
        }

        // æ™ºèƒ½å¸é™„åŠŸèƒ½
        function getSnappedPosition(x, y, currentImage) {
            if (!canvasSettings.snapToGrid) return { x, y };

            const SNAP_THRESHOLD = 10; // å¸é™„é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
            let snappedX = x;
            let snappedY = y;
            let snapped = false;

            // 1. ä¼˜å…ˆå¸é™„ç”»å¸ƒè¾¹ç¼˜
            const edges = [
                { pos: 0, label: 'å·¦è¾¹ç¼˜' },
                { pos: canvas.width / 2, label: 'æ°´å¹³ä¸­å¿ƒ' },
                { pos: canvas.width, label: 'å³è¾¹ç¼˜' }
            ];

            const verticalEdges = [
                { pos: 0, label: 'ä¸Šè¾¹ç¼˜' },
                { pos: canvas.height / 2, label: 'å‚ç›´ä¸­å¿ƒ' },
                { pos: canvas.height, label: 'ä¸‹è¾¹ç¼˜' }
            ];

            // è·å–å½“å‰å›¾ç‰‡çš„å°ºå¯¸
            const imgWidth = currentImage.width * currentImage.scale;
            const imgHeight = currentImage.height * currentImage.scale;

            // æ£€æŸ¥æ°´å¹³å¸é™„
            for (const edge of edges) {
                if (Math.abs(x - edge.pos) < SNAP_THRESHOLD) {
                    snappedX = edge.pos;
                    snapped = true;
                    break;
                }
                // æ£€æŸ¥å›¾ç‰‡å³è¾¹ç¼˜å¸é™„
                if (Math.abs((x + imgWidth) - edge.pos) < SNAP_THRESHOLD) {
                    snappedX = edge.pos - imgWidth;
                    snapped = true;
                    break;
                }
                // æ£€æŸ¥å›¾ç‰‡ä¸­å¿ƒå¸é™„
                if (Math.abs((x + imgWidth / 2) - edge.pos) < SNAP_THRESHOLD) {
                    snappedX = edge.pos - imgWidth / 2;
                    snapped = true;
                    break;
                }
            }

            // æ£€æŸ¥å‚ç›´å¸é™„
            for (const edge of verticalEdges) {
                if (Math.abs(y - edge.pos) < SNAP_THRESHOLD) {
                    snappedY = edge.pos;
                    snapped = true;
                    break;
                }
                // æ£€æŸ¥å›¾ç‰‡ä¸‹è¾¹ç¼˜å¸é™„
                if (Math.abs((y + imgHeight) - edge.pos) < SNAP_THRESHOLD) {
                    snappedY = edge.pos - imgHeight;
                    snapped = true;
                    break;
                }
                // æ£€æŸ¥å›¾ç‰‡ä¸­å¿ƒå¸é™„
                if (Math.abs((y + imgHeight / 2) - edge.pos) < SNAP_THRESHOLD) {
                    snappedY = edge.pos - imgHeight / 2;
                    snapped = true;
                    break;
                }
            }

            // 2. å¦‚æœæ²¡æœ‰å¸é™„åˆ°è¾¹ç¼˜ï¼Œå°è¯•å¸é™„åˆ°å…¶ä»–å›¾ç‰‡è¾¹ç¼˜
            if (!snapped) {
                for (const img of uploadedImages) {
                    if (img.id === currentImage.id) continue;

                    const otherWidth = img.width * img.scale;
                    const otherHeight = img.height * img.scale;

                    // å…¶ä»–å›¾ç‰‡çš„å·¦ã€å³ã€ä¸­å¿ƒ
                    const otherPositions = [
                        img.x, // å·¦
                        img.x + otherWidth, // å³
                        img.x + otherWidth / 2 // ä¸­å¿ƒ
                    ];

                    const otherVerticalPositions = [
                        img.y, // ä¸Š
                        img.y + otherHeight, // ä¸‹
                        img.y + otherHeight / 2 // ä¸­å¿ƒ
                    ];

                    // æ£€æŸ¥ä¸å…¶ä»–å›¾ç‰‡çš„æ°´å¹³å¯¹é½
                    for (const pos of otherPositions) {
                        // å·¦è¾¹å¯¹é½
                        if (Math.abs(x - pos) < SNAP_THRESHOLD) {
                            snappedX = pos;
                            snapped = true;
                            break;
                        }
                        // å³è¾¹å¯¹é½
                        if (Math.abs((x + imgWidth) - pos) < SNAP_THRESHOLD) {
                            snappedX = pos - imgWidth;
                            snapped = true;
                            break;
                        }
                        // ä¸­å¿ƒå¯¹é½
                        if (Math.abs((x + imgWidth / 2) - pos) < SNAP_THRESHOLD) {
                            snappedX = pos - imgWidth / 2;
                            snapped = true;
                            break;
                        }
                    }

                    // æ£€æŸ¥ä¸å…¶ä»–å›¾ç‰‡çš„å‚ç›´å¯¹é½
                    for (const pos of otherVerticalPositions) {
                        // ä¸Šè¾¹å¯¹é½
                        if (Math.abs(y - pos) < SNAP_THRESHOLD) {
                            snappedY = pos;
                            snapped = true;
                            break;
                        }
                        // ä¸‹è¾¹å¯¹é½
                        if (Math.abs((y + imgHeight) - pos) < SNAP_THRESHOLD) {
                            snappedY = pos - imgHeight;
                            snapped = true;
                            break;
                        }
                        // ä¸­å¿ƒå¯¹é½
                        if (Math.abs((y + imgHeight / 2) - pos) < SNAP_THRESHOLD) {
                            snappedY = pos - imgHeight / 2;
                            snapped = true;
                            break;
                        }
                    }

                    if (snapped) break;
                }
            }

            // 3. å¦‚æœéƒ½æ²¡æœ‰å¸é™„ï¼Œä½¿ç”¨ç½‘æ ¼å¸é™„
            if (!snapped) {
                snappedX = Math.round(x / GRID_SIZE) * GRID_SIZE;
                snappedY = Math.round(y / GRID_SIZE) * GRID_SIZE;
            }

            return { x: snappedX, y: snappedY };
        }

        function getTransformedBounds(image) {
            const actualWidth = image.width * image.scale;
            const actualHeight = image.height * image.scale;
            const centerX = image.x + actualWidth / 2;
            const centerY = image.y + actualHeight / 2;

            // ç®€åŒ–ï¼šå¯¹äºæœªæ—‹è½¬æˆ–æ—‹è½¬è§’åº¦è¾ƒå°çš„æƒ…å†µï¼Œä½¿ç”¨è¾¹ç•ŒçŸ©å½¢
            if (image.rotation === 0) {
                return {
                    left: image.x,
                    right: image.x + actualWidth,
                    top: image.y,
                    bottom: image.y + actualHeight
                };
            }

            // å¯¹äºæ—‹è½¬çš„æƒ…å†µï¼Œè¿”å›ä¸€ä¸ªè¿‘ä¼¼çš„è¾¹ç•ŒçŸ©å½¢
            const angle = (image.rotation * Math.PI) / 180;
            const cos = Math.abs(Math.cos(angle));
            const sin = Math.abs(Math.sin(angle));
            const rotatedWidth = image.width * cos + image.height * sin;
            const rotatedHeight = image.width * sin + image.height * cos;

            return {
                left: centerX - rotatedWidth / 2,
                right: centerX + rotatedWidth / 2,
                top: centerY - rotatedHeight / 2,
                bottom: centerY + rotatedHeight / 2
            };
        }

        function hitTestImage(x, y) {
            // ä»åå¾€å‰æ£€æµ‹ï¼ˆå› ä¸ºåé¢çš„å›¾ç‰‡åœ¨ä¸Šé¢ï¼‰
            for (let i = uploadedImages.length - 1; i >= 0; i--) {
                const image = uploadedImages[i];
                const bounds = getTransformedBounds(image);

                if (x >= bounds.left && x <= bounds.right && y >= bounds.top && y <= bounds.bottom) {
                    return image;
                }
            }
            return null;
        }

        function getResizeHandle(x, y, image) {
            if (!image) return null;

            const actualWidth = image.width * image.scale;
            const actualHeight = image.height * image.scale;
            const handleRadius = 10;

            // æœªæ—‹è½¬æ—¶æ£€æµ‹å››ä¸ªè§’
            if (image.rotation === 0) {
                if (distance(x, y, image.x, image.y) < handleRadius) return 'tl';
                if (distance(x, y, image.x + actualWidth, image.y) < handleRadius) return 'tr';
                if (distance(x, y, image.x, image.y + actualHeight) < handleRadius) return 'bl';
                if (distance(x, y, image.x + actualWidth, image.y + actualHeight) < handleRadius) return 'br';
            }

            return null;
        }

        function distance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function handleMouseDown(e) {
            const coords = getCanvasCoordinates(e);
            const selectedImage = uploadedImages.find(img => img.id === selectedImageId);
            const handle = getResizeHandle(coords.x, coords.y, selectedImage);

            if (handle) {
                // è°ƒæ•´å¤§å°
                isResizing = true;
                resizeHandle = handle;
                dragStart = coords;
            } else {
                // é€‰æ‹©æˆ–æ‹–æ‹½
                const clickedImage = hitTestImage(coords.x, coords.y);
                if (clickedImage) {
                    selectImage(clickedImage.id);
                    isDragging = true;
                    dragStart = coords;
                } else {
                    selectImage(null);
                }
            }
        }

        function handleMouseMove(e) {
            const coords = getCanvasCoordinates(e);

            // æ›´æ–°å…‰æ ‡æ ·å¼
            const selectedImage = uploadedImages.find(img => img.id === selectedImageId);
            const handle = getResizeHandle(coords.x, coords.y, selectedImage);
            const clickedImage = hitTestImage(coords.x, coords.y);

            if (isResizing) {
                canvas.style.cursor = 'crosshair';
            } else if (isDragging) {
                canvas.style.cursor = 'move';
            } else if (handle) {
                canvas.style.cursor = 'crosshair';
            } else if (clickedImage) {
                canvas.style.cursor = 'move';
            } else {
                canvas.style.cursor = 'default';
            }

            // å¤„ç†è°ƒæ•´å¤§å°
            if (isResizing && selectedImage) {
                const dx = coords.x - dragStart.x;
                const newScale = Math.max(0.1, Math.min(3, selectedImage.scale + dx / selectedImage.width));
                selectedImage.scale = newScale;

                dragStart = coords;
                render();
                updatePropertiesPanel();
                return;
            }

            // å¤„ç†æ‹–æ‹½
            if (isDragging && selectedImage) {
                const newX = selectedImage.x + (coords.x - dragStart.x);
                const newY = selectedImage.y + (coords.y - dragStart.y);

                // ä½¿ç”¨æ™ºèƒ½å¸é™„
                const snapped = getSnappedPosition(newX, newY, selectedImage);

                selectedImage.x = snapped.x;
                selectedImage.y = snapped.y;

                dragStart = coords;
                render();
                updatePropertiesPanel();
            }
        }

        function handleMouseUp(e) {
            isDragging = false;
            isResizing = false;
            resizeHandle = null;
        }

        // ==================== é€‰æ‹©å’Œå±æ€§ ====================
        function selectImage(id) {
            selectedImageId = id;
            updateImagesList();
            updatePropertiesPanel();
            render();
        }

        function updatePropertiesPanel() {
            const image = uploadedImages.find(img => img.id === selectedImageId);

            if (!image) {
                imagePropertiesPanel.classList.add('hidden');
                return;
            }

            imagePropertiesPanel.classList.remove('hidden');
            document.getElementById('propX').value = Math.round(image.x);
            document.getElementById('propY').value = Math.round(image.y);
            document.getElementById('propWidth').value = Math.round(image.width * image.scale);
            document.getElementById('propHeight').value = Math.round(image.height * image.scale);
            document.getElementById('propRotation').value = image.rotation;
            document.getElementById('rotationValue').textContent = image.rotation;
            document.getElementById('propScale').value = Math.round(image.scale * 100);
            document.getElementById('scaleValue').textContent = Math.round(image.scale * 100);
        }

        function updateSelectedImageFromProps() {
            const image = uploadedImages.find(img => img.id === selectedImageId);
            if (!image) return;

            image.x = parseInt(document.getElementById('propX').value) || 0;
            image.y = parseInt(document.getElementById('propY').value) || 0;
            image.width = parseInt(document.getElementById('propWidth').value) || image.originalWidth;
            image.height = parseInt(document.getElementById('propHeight').value) || image.originalHeight;
            image.rotation = parseInt(document.getElementById('propRotation').value) || 0;
            image.scale = (parseInt(document.getElementById('propScale').value) || 100) / 100;

            render();
        }

        function deleteSelectedImage() {
            if (!selectedImageId) return;

            uploadedImages = uploadedImages.filter(img => img.id !== selectedImageId);
            selectImage(null);
            updateImagesList();
            render();
            showToast('å›¾ç‰‡å·²åˆ é™¤');
        }

        function changeImageOrder(direction) {
            if (!selectedImageId) return;

            const index = uploadedImages.findIndex(img => img.id === selectedImageId);
            if (index === -1) return;

            const image = uploadedImages.splice(index, 1)[0];

            if (direction === 'front') {
                uploadedImages.push(image);
            } else {
                uploadedImages.unshift(image);
            }

            render();
            showToast('å›¾å±‚é¡ºåºå·²è°ƒæ•´');
        }

        // ==================== ç”»å¸ƒè®¾ç½® ====================
        function applyCanvasSettings() {
            canvasSettings.width = parseInt(document.getElementById('canvasWidth').value) || 1920;
            canvasSettings.height = parseInt(document.getElementById('canvasHeight').value) || 1080;
            canvasSettings.bgColor = document.getElementById('bgColorInput').value;
            canvasSettings.transparent = document.getElementById('transparentBg').checked;

            canvas.width = canvasSettings.width;
            canvas.height = canvasSettings.height;
            fitCanvasToScreen();
            render();
            showToast('ç”»å¸ƒè®¾ç½®å·²åº”ç”¨');
        }

        function resetCanvas() {
            canvasSettings = {
                width: 1920,
                height: 1080,
                bgColor: '#ffffff',
                transparent: false,
                showGrid: true,
                snapToGrid: true
            };

            document.getElementById('canvasWidth').value = 1920;
            document.getElementById('canvasHeight').value = 1080;
            document.getElementById('bgColorInput').value = '#ffffff';
            document.getElementById('bgColorText').value = '#ffffff';
            document.getElementById('transparentBg').checked = false;
            document.getElementById('bgColorInput').disabled = false;
            document.getElementById('bgColorText').disabled = false;
            document.getElementById('showGrid').checked = true;
            document.getElementById('snapToGrid').checked = true;
            document.getElementById('presetSize').value = '1920x1080';

            applyCanvasSettings();
        }

        function setZoom(zoom) {
            canvasZoom = Math.max(0.1, Math.min(3, zoom));
            canvas.style.width = (canvas.width * canvasZoom) + 'px';
            canvas.style.height = (canvas.height * canvasZoom) + 'px';
            document.getElementById('zoomLevel').textContent = Math.round(canvasZoom * 100) + '%';
        }

        // ==================== å¯¼å‡ºåŠŸèƒ½ ====================
        function downloadResult() {
            // å–æ¶ˆé€‰æ‹©ä»¥é¿å…å¯¼å‡ºé€‰ä¸­æ¡†
            const previousSelection = selectedImageId;
            selectImage(null);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const format = document.querySelector('input[name="format"]:checked')?.value || 'png';
            const a = document.createElement('a');
            a.href = canvas.toDataURL(`image/${format}`, 0.9);
            a.download = `merged_image_${Date.now()}.${format === 'jpeg' ? 'jpg' : format}`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // æ¢å¤é€‰æ‹©
            selectImage(previousSelection);
            showToast('ä¸‹è½½æˆåŠŸï¼');
        }

        function clearAll() {
            if (uploadedImages.length === 0) return;

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                return;
            }

            uploadedImages = [];
            selectImage(null);
            updateImagesList();
            render();
            showToast('å·²æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡');
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast px-6 py-3 rounded-lg shadow-lg text-white font-medium ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // ==================== å¯åŠ¨ ====================
        init();
    </script>
</body>
</html>
