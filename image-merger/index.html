<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ‹¼æ¥å·¥å…· - Image Merger</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼è¡¥å…… */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .upload-area {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #fff;
        }

        .upload-area.dragover .upload-text {
            color: white;
        }

        /* æ‹–æ‹½æ’åºæ ·å¼ */
        .image-item {
            cursor: move;
            transition: all 0.3s;
        }

        .image-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .image-item.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-6">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">ğŸ”— å›¾ç‰‡æ‹¼æ¥å·¥å…·</h1>
            <p class="text-gray-600 text-sm md:text-base">å°†å¤šå¼ å›¾ç‰‡æ‹¼æ¥æˆä¸€å¼ å¤§å›¾ï¼Œæ”¯æŒæ°´å¹³å’Œå‚ç›´æ‹¼æ¥</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- å·¦ä¾§ï¼šè®¾ç½®é¢æ¿ -->
            <div class="lg:col-span-1 space-y-4">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area border-3 border-dashed border-indigo-500 rounded-xl p-4 text-center cursor-pointer"
                     id="uploadSection">
                    <div class="text-3xl mb-1">ğŸ“</div>
                    <div class="upload-text text-gray-700 font-medium text-sm">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                    <div class="text-gray-500 text-xs mt-1">æ”¯æŒå¤šé€‰ï¼Œå¯æ‹–æ‹½æ’åº</div>
                    <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
                </div>

                <!-- æ‹¼æ¥è®¾ç½® -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3">âš™ï¸ æ‹¼æ¥è®¾ç½®</h3>

                    <div class="space-y-3">
                        <!-- æ‹¼æ¥æ–¹å‘ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ‹¼æ¥æ–¹å‘</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="direction" value="horizontal" checked class="peer sr-only">
                                    <div class="w-full px-3 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        â¬‡ï¸ æ°´å¹³æ‹¼æ¥
                                        <span class="block text-gray-500 mt-0.5">ä»ä¸Šåˆ°ä¸‹</span>
                                    </div>
                                </label>
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="direction" value="vertical" class="peer sr-only">
                                    <div class="w-full px-3 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        â¡ï¸ å‚ç›´æ‹¼æ¥
                                        <span class="block text-gray-500 mt-0.5">ä»å·¦åˆ°å³</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- é—´è· -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">å›¾ç‰‡é—´è·: <span id="spacingValue">0</span>px</label>
                            <input type="range" id="spacingInput" value="0" min="0" max="100"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- èƒŒæ™¯é¢œè‰² -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">èƒŒæ™¯é¢œè‰²</label>
                            <div class="flex gap-2">
                                <input type="color" id="bgColorInput" value="#ffffff"
                                       class="w-12 h-10 rounded cursor-pointer border-2 border-gray-300">
                                <input type="text" id="bgColorText" value="#ffffff"
                                       class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- è¾“å‡ºæ ¼å¼ -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">è¾“å‡ºæ ¼å¼</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="format" value="png" checked class="peer sr-only">
                                    <div class="w-full px-2 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        PNG
                                        <span class="block text-gray-500">æ— æŸ</span>
                                    </div>
                                </label>
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="format" value="jpeg" class="peer sr-only">
                                    <div class="w-full px-2 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        JPEG
                                        <span class="block text-gray-500">å°ä½“ç§¯</span>
                                    </div>
                                </label>
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="format" value="webp" class="peer sr-only">
                                    <div class="w-full px-2 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        WebP
                                        <span class="block text-gray-500">æ¨è</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex gap-2 pt-2">
                            <button id="mergeBtn" disabled
                                    class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transition-all">
                                å¼€å§‹æ‹¼æ¥
                            </button>
                            <button id="clearBtn"
                                    class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-all">
                                æ¸…ç©º
                            </button>
                        </div>

                        <button id="downloadBtn" disabled
                                class="w-full bg-green-500 text-white py-2 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l4-4m-4 4h4"></path>
                            </svg>
                            ä¸‹è½½ç»“æœ
                        </button>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div id="statsSection" class="bg-blue-50 rounded-xl p-4 hidden">
                    <h3 class="text-sm font-semibold text-blue-700 mb-2">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                    <div class="space-y-1 text-xs text-gray-600">
                        <div class="flex justify-between">
                            <span>å›¾ç‰‡æ•°é‡ï¼š</span>
                            <span id="totalImages" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ€»å®½åº¦ï¼š</span>
                            <span id="totalWidth" class="font-medium">0 px</span>
                        </div>
                        <div class="flex justify-between">
                            <span>æ€»é«˜åº¦ï¼š</span>
                            <span id="totalHeight" class="font-medium">0 px</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå›¾ç‰‡åˆ—è¡¨å’Œé¢„è§ˆ -->
            <div class="lg:col-span-2 space-y-4">
                <!-- å›¾ç‰‡åˆ—è¡¨ -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-indigo-600">ğŸ“· å›¾ç‰‡åˆ—è¡¨</h3>
                        <span id="imageCountBadge" class="text-sm text-gray-500">0 å¼ å›¾ç‰‡</span>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="emptyState" class="flex flex-col items-center justify-center h-64 text-gray-400">
                        <div class="text-5xl mb-3">ğŸ“·</div>
                        <p class="text-lg">è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹</p>
                        <p class="text-sm mt-2">æ”¯æŒå¤šé€‰å’Œæ‹–æ‹½æ’åº</p>
                    </div>

                    <!-- å›¾ç‰‡ç½‘æ ¼ -->
                    <div id="imagesList" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-80 overflow-y-auto hidden"></div>
                </div>

                <!-- é¢„è§ˆåŒºåŸŸ -->
                <div id="previewSection" class="bg-gray-50 rounded-xl p-4 hidden">
                    <h3 class="text-lg font-semibold text-green-600 mb-3">ğŸ‘ï¸ æ‹¼æ¥ç»“æœ</h3>

                    <!-- åŠ è½½åŠ¨ç”» -->
                    <div id="loading" class="hidden flex flex-col items-center justify-center h-64">
                        <div class="w-10 h-10 border-4 border-gray-300 border-t-indigo-500 rounded-full animate-spin mb-3"></div>
                        <p class="text-gray-600">æ­£åœ¨æ‹¼æ¥å›¾ç‰‡...</p>
                    </div>

                    <!-- é¢„è§ˆå®¹å™¨ -->
                    <div id="previewContainer" class="hidden bg-white rounded-lg p-4 shadow-inner">
                        <img id="mergedImage" class="max-w-full h-auto mx-auto" alt="æ‹¼æ¥ç»“æœ">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast hidden"></div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let uploadedImages = [];
        let mergedImageUrl = null;
        let draggedItem = null;

        // ==================== DOM å…ƒç´  ====================
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const mergeBtn = document.getElementById('mergeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const emptyState = document.getElementById('emptyState');
        const imagesList = document.getElementById('imagesList');
        const imageCountBadge = document.getElementById('imageCountBadge');
        const previewSection = document.getElementById('previewSection');
        const loading = document.getElementById('loading');
        const previewContainer = document.getElementById('previewContainer');
        const mergedImage = document.getElementById('mergedImage');
        const spacingInput = document.getElementById('spacingInput');
        const spacingValue = document.getElementById('spacingValue');
        const bgColorInput = document.getElementById('bgColorInput');
        const bgColorText = document.getElementById('bgColorText');
        const statsSection = document.getElementById('statsSection');
        const totalImagesEl = document.getElementById('totalImages');
        const totalWidthEl = document.getElementById('totalWidth');
        const totalHeightEl = document.getElementById('totalHeight');

        // ==================== äº‹ä»¶ç›‘å¬ ====================

        // æ–‡ä»¶ä¸Šä¼ 
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // æ‹–æ‹½ä¸Šä¼ 
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // èƒŒæ™¯é¢œè‰²åŒæ­¥
        bgColorInput.addEventListener('input', (e) => {
            bgColorText.value = e.target.value;
        });
        bgColorText.addEventListener('input', (e) => {
            if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                bgColorInput.value = e.target.value;
            }
        });

        // é—´è·æ»‘å—
        spacingInput.addEventListener('input', (e) => {
            spacingValue.textContent = e.target.value;
            updateStats();
        });

        // æŒ‰é’®äº‹ä»¶
        mergeBtn.addEventListener('click', mergeImages);
        clearBtn.addEventListener('click', clearAll);
        downloadBtn.addEventListener('click', downloadResult);

        // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================

        /**
         * å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
         */
        function handleFiles(files) {
            if (!files || files.length === 0) return;

            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

            if (validFiles.length === 0) {
                showToast('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            showToast(`æ­£åœ¨å¤„ç† ${validFiles.length} å¼ å›¾ç‰‡...`);

            let processedCount = 0;
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImages.push({
                            id: Date.now() + Math.random(),
                            name: file.name,
                            src: e.target.result,
                            width: img.width,
                            height: img.height,
                            element: img
                        });

                        processedCount++;
                        if (processedCount === validFiles.length) {
                            updateImagesList();
                            showToast(`æˆåŠŸæ·»åŠ  ${validFiles.length} å¼ å›¾ç‰‡`);
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        /**
         * æ›´æ–°å›¾ç‰‡åˆ—è¡¨æ˜¾ç¤º
         */
        function updateImagesList() {
            if (uploadedImages.length === 0) {
                emptyState.classList.remove('hidden');
                imagesList.classList.add('hidden');
                mergeBtn.disabled = true;
                statsSection.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            imagesList.classList.remove('hidden');
            imageCountBadge.textContent = `${uploadedImages.length} å¼ å›¾ç‰‡`;
            mergeBtn.disabled = false;
            statsSection.classList.remove('hidden');

            imagesList.innerHTML = '';

            uploadedImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'image-item bg-white rounded-lg shadow p-2 relative';
                item.draggable = true;
                item.dataset.index = index;

                item.innerHTML = `
                    <div class="absolute top-2 left-2 bg-gray-800 text-white text-xs px-2 py-1 rounded font-medium">
                        ${index + 1}
                    </div>
                    <img src="${image.src}" class="w-full h-24 object-contain rounded bg-gray-100 mb-2" alt="${image.name}">
                    <div class="text-xs text-gray-600 truncate mb-2" title="${image.name}">${image.name}</div>
                    <div class="flex gap-1">
                        <button onclick="moveImage(${index}, -1)" class="flex-1 px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" ${index === 0 ? 'disabled' : ''}>
                            â†‘
                        </button>
                        <button onclick="moveImage(${index}, 1)" class="flex-1 px-2 py-1 text-xs bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed" ${index === uploadedImages.length - 1 ? 'disabled' : ''}>
                            â†“
                        </button>
                        <button onclick="deleteImage(${index})" class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600">
                            âœ•
                        </button>
                    </div>
                `;

                // æ‹–æ‹½äº‹ä»¶
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);

                imagesList.appendChild(item);
            });

            updateStats();
        }

        /**
         * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
         */
        function updateStats() {
            const direction = document.querySelector('input[name="direction"]:checked').value;
            const spacing = parseInt(spacingInput.value) || 0;

            totalImagesEl.textContent = uploadedImages.length;

            if (uploadedImages.length === 0) {
                totalWidthEl.textContent = '0 px';
                totalHeightEl.textContent = '0 px';
                return;
            }

            if (direction === 'horizontal') {
                const maxWidth = Math.max(...uploadedImages.map(img => img.width));
                const totalHeight = uploadedImages.reduce((sum, img) => sum + img.height, 0) + (uploadedImages.length - 1) * spacing;
                totalWidthEl.textContent = `${maxWidth} px`;
                totalHeightEl.textContent = `${totalHeight} px`;
            } else {
                const maxHeight = Math.max(...uploadedImages.map(img => img.height));
                const totalWidth = uploadedImages.reduce((sum, img) => sum + img.width, 0) + (uploadedImages.length - 1) * spacing;
                totalWidthEl.textContent = `${totalWidth} px`;
                totalHeightEl.textContent = `${maxHeight} px`;
            }
        }

        /**
         * æ‹–æ‹½å¼€å§‹
         */
        function handleDragStart(e) {
            draggedItem = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        /**
         * æ‹–æ‹½ç»“æŸ
         */
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.image-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        /**
         * æ‹–æ‹½ç»è¿‡
         */
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        /**
         * æ‹–æ‹½æ”¾ç½®
         */
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedItem !== this) {
                const fromIndex = parseInt(draggedItem.dataset.index);
                const toIndex = parseInt(this.dataset.index);

                const item = uploadedImages.splice(fromIndex, 1)[0];
                uploadedImages.splice(toIndex, 0, item);

                updateImagesList();
                showToast('é¡ºåºå·²è°ƒæ•´');
            }

            return false;
        }

        /**
         * æ‹–æ‹½è¿›å…¥
         */
        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        /**
         * æ‹–æ‹½ç¦»å¼€
         */
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        /**
         * ç§»åŠ¨å›¾ç‰‡ä½ç½®
         */
        window.moveImage = function(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= uploadedImages.length) return;

            const temp = uploadedImages[index];
            uploadedImages[index] = uploadedImages[newIndex];
            uploadedImages[newIndex] = temp;

            updateImagesList();
        };

        /**
         * åˆ é™¤å›¾ç‰‡
         */
        window.deleteImage = function(index) {
            uploadedImages.splice(index, 1);
            updateImagesList();
            showToast('å›¾ç‰‡å·²åˆ é™¤');
        };

        /**
         * æ‹¼æ¥å›¾ç‰‡
         */
        function mergeImages() {
            if (uploadedImages.length < 2) {
                showToast('è¯·è‡³å°‘ä¸Šä¼  2 å¼ å›¾ç‰‡è¿›è¡Œæ‹¼æ¥', 'error');
                return;
            }

            const direction = document.querySelector('input[name="direction"]:checked').value;
            const spacing = parseInt(spacingInput.value) || 0;
            const bgColor = bgColorInput.value;
            const format = document.querySelector('input[name="format"]:checked').value;

            loading.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            mergeBtn.disabled = true;

            setTimeout(() => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    if (direction === 'horizontal') {
                        // æ°´å¹³æ‹¼æ¥ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
                        const maxWidth = Math.max(...uploadedImages.map(img => img.width));
                        const totalHeight = uploadedImages.reduce((sum, img) => sum + img.height, 0) + (uploadedImages.length - 1) * spacing;

                        canvas.width = maxWidth;
                        canvas.height = totalHeight;

                        ctx.fillStyle = bgColor;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        let currentY = 0;
                        uploadedImages.forEach(img => {
                            const x = (maxWidth - img.width) / 2;
                            ctx.drawImage(img.element, x, currentY, img.width, img.height);
                            currentY += img.height + spacing;
                        });
                    } else {
                        // å‚ç›´æ‹¼æ¥ï¼ˆä»å·¦åˆ°å³ï¼‰
                        const maxHeight = Math.max(...uploadedImages.map(img => img.height));
                        const totalWidth = uploadedImages.reduce((sum, img) => sum + img.width, 0) + (uploadedImages.length - 1) * spacing;

                        canvas.width = totalWidth;
                        canvas.height = maxHeight;

                        ctx.fillStyle = bgColor;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        let currentX = 0;
                        uploadedImages.forEach(img => {
                            const y = (maxHeight - img.height) / 2;
                            ctx.drawImage(img.element, currentX, y, img.width, img.height);
                            currentX += img.width + spacing;
                        });
                    }

                    canvas.toBlob((blob) => {
                        if (mergedImageUrl) {
                            URL.revokeObjectURL(mergedImageUrl);
                        }
                        mergedImageUrl = URL.createObjectURL(blob);

                        mergedImage.src = mergedImageUrl;
                        loading.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                        previewSection.classList.remove('hidden');
                        downloadBtn.disabled = false;
                        mergeBtn.disabled = false;

                        showToast('å›¾ç‰‡æ‹¼æ¥æˆåŠŸï¼');
                    }, `image/${format}`, 0.9);
                } catch (error) {
                    loading.classList.add('hidden');
                    mergeBtn.disabled = false;
                    showToast('å›¾ç‰‡æ‹¼æ¥å¤±è´¥ï¼š' + error.message, 'error');
                    console.error(error);
                }
            }, 100);
        }

        /**
         * ä¸‹è½½æ‹¼æ¥ç»“æœ
         */
        function downloadResult() {
            if (!mergedImageUrl) return;

            const a = document.createElement('a');
            a.href = mergedImageUrl;

            const format = document.querySelector('input[name="format"]:checked').value;
            const ext = format === 'jpeg' ? 'jpg' : format;
            a.download = `merged_image_${Date.now()}.${ext}`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showToast('ä¸‹è½½æˆåŠŸï¼');
        }

        /**
         * æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡
         */
        function clearAll() {
            if (uploadedImages.length === 0) return;

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡å—ï¼Ÿ')) {
                return;
            }

            uploadedImages = [];
            if (mergedImageUrl) {
                URL.revokeObjectURL(mergedImageUrl);
                mergedImageUrl = null;
            }

            updateImagesList();
            previewSection.classList.add('hidden');
            downloadBtn.disabled = true;

            showToast('å·²æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡');
        }

        /**
         * æ˜¾ç¤º Toast æç¤º
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast px-6 py-3 rounded-lg shadow-lg text-white font-medium ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // åˆå§‹åŒ–
        updateStats();
    </script>
</body>
</html>
