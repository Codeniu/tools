<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åˆ†å‰²å·¥å…· - Image Splitter</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼è¡¥å…… */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .upload-area {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #fff;
        }

        .upload-area.dragover .upload-text,
        .upload-area.dragover .upload-hint {
            color: white;
        }

        /* é¢„è§ˆå®¹å™¨ */
        .preview-container {
            position: relative;
            display: inline-block;
        }

        .preview-wrapper {
            position: relative;
            overflow: hidden;
        }

        .preview-image {
            display: block;
            max-width: 100%;
            height: auto;
        }

        /* åˆ†å‰²çº¿æ ·å¼ */
        .split-line {
            position: absolute;
            background: #667eea;
            cursor: move;
            z-index: 10;
            transition: background 0.2s;
        }

        .split-line:hover {
            background: #764ba2;
        }

        .split-line.active {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        .split-line.horizontal {
            width: 100%;
            height: 3px;
            cursor: ns-resize;
        }

        .split-line.vertical {
            height: 100%;
            width: 3px;
            cursor: ew-resize;
        }

        /* åˆ†å‰²çº¿æ§åˆ¶ç‚¹ */
        .split-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            transition: all 0.2s;
        }

        .split-line:hover .split-handle {
            width: 24px;
            height: 24px;
            border-color: #764ba2;
        }

        .split-line.active .split-handle {
            background: #f59e0b;
            border-color: #f59e0b;
        }

        /* ç½‘æ ¼é¢„è§ˆ */
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .grid-cell {
            position: absolute;
            border: 1px dashed rgba(102, 126, 234, 0.5);
            box-sizing: border-box;
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ç»“æœå¡ç‰‡ */
        .result-card {
            transition: all 0.3s;
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-2xl p-4 md:p-6">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">ğŸ–¼ï¸ å›¾ç‰‡åˆ†å‰²å·¥å…·</h1>
            <p class="text-gray-600 text-sm md:text-base">å°†å›¾ç‰‡æŒ‰ç½‘æ ¼åˆ†å‰²æˆ–æ‰‹åŠ¨è°ƒæ•´åˆ†å‰²çº¿</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- å·¦ä¾§ï¼šè®¾ç½®é¢æ¿ -->
            <div class="lg:col-span-1 space-y-4">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-area border-3 border-dashed border-indigo-500 rounded-xl p-6 text-center cursor-pointer"
                     id="uploadSection">
                    <div class="text-4xl mb-2">ğŸ“</div>
                    <div class="upload-text text-gray-700 font-medium text-sm">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
                    <div class="upload-hint text-gray-500 text-xs mt-1">æ”¯æŒ JPGã€PNGã€GIFã€WebP</div>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </div>

                <!-- åˆ†å‰²è®¾ç½® -->
                <div class="bg-gray-50 rounded-xl p-4">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3">âš™ï¸ åˆ†å‰²è®¾ç½®</h3>

                    <div class="space-y-3">
                        <!-- åˆ†å‰²æ¨¡å¼ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†å‰²æ¨¡å¼</label>
                            <div class="flex gap-3">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="splitMode" value="auto" checked class="w-4 h-4 text-indigo-600">
                                    <span class="text-sm">è‡ªåŠ¨ç½‘æ ¼</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="splitMode" value="manual" class="w-4 h-4 text-indigo-600">
                                    <span class="text-sm">æ‰‹åŠ¨è°ƒæ•´</span>
                                </label>
                            </div>
                        </div>

                        <!-- ç½‘æ ¼è®¾ç½® -->
                        <div id="gridSettings">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">è¡Œæ•°</label>
                                    <input type="number" id="rowsInput" value="2" min="1" max="20"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">åˆ—æ•°</label>
                                    <input type="number" id="colsInput" value="2" min="1" max="20"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                            </div>
                        </div>

                        <!-- è¾“å‡ºæ ¼å¼ -->
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-2">è¾“å‡ºæ ¼å¼</label>
                            <div class="grid grid-cols-3 gap-2">
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="format" value="png" checked class="peer sr-only">
                                    <div class="w-full px-3 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        PNG
                                        <span class="block text-gray-500 mt-0.5">æ— æŸ</span>
                                    </div>
                                </label>
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="format" value="jpeg" class="peer sr-only">
                                    <div class="w-full px-3 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        JPEG
                                        <span class="block text-gray-500 mt-0.5">å°ä½“ç§¯</span>
                                    </div>
                                </label>
                                <label class="relative flex cursor-pointer">
                                    <input type="radio" name="format" value="webp" class="peer sr-only">
                                    <div class="w-full px-3 py-2 text-center text-xs border-2 border-gray-300 rounded-lg peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all hover:border-indigo-300">
                                        WebP
                                        <span class="block text-gray-500 mt-0.5">æ¨è</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- å›¾ç‰‡è´¨é‡ -->
                        <div id="qualitySetting">
                            <label class="block text-xs font-medium text-gray-600 mb-1">å›¾ç‰‡è´¨é‡: <span id="qualityValue">90</span></label>
                            <input type="range" id="qualityInput" value="90" min="1" max="100"
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex gap-2 pt-2">
                            <button id="splitBtn" disabled
                                    class="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-2 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transition-all">
                                å¼€å§‹åˆ†å‰²
                            </button>
                            <button id="resetBtn"
                                    class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300 transition-all">
                                é‡ç½®
                            </button>
                        </div>

                        <button id="downloadAllBtn" disabled
                                class="w-full bg-green-500 text-white py-2 px-4 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            ä¸‹è½½ ZIP
                        </button>
                    </div>
                </div>

                <!-- å›¾ç‰‡ä¿¡æ¯ -->
                <div id="imageInfo" class="bg-blue-50 rounded-xl p-4 hidden">
                    <h3 class="text-sm font-semibold text-blue-700 mb-2">ğŸ“Š å›¾ç‰‡ä¿¡æ¯</h3>
                    <div class="space-y-1 text-xs text-gray-600">
                        <div class="flex justify-between">
                            <span>æ–‡ä»¶åï¼š</span>
                            <span id="infoFileName" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å°ºå¯¸ï¼š</span>
                            <span id="infoImageSize" class="font-medium">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>å¤§å°ï¼š</span>
                            <span id="infoFileSize" class="font-medium">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šé¢„è§ˆå’Œç»“æœ -->
            <div class="lg:col-span-2 space-y-4">
                <!-- é¢„è§ˆåŒºåŸŸ -->
                <div class="bg-gray-50 rounded-xl p-4 min-h-[400px]">
                    <h3 class="text-lg font-semibold text-indigo-600 mb-3">ğŸ‘ï¸ é¢„è§ˆåŒºåŸŸ</h3>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="emptyState" class="flex flex-col items-center justify-center h-80 text-gray-400">
                        <div class="text-6xl mb-4">ğŸ“·</div>
                        <p class="text-lg">è¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹</p>
                    </div>

                    <!-- é¢„è§ˆå®¹å™¨ -->
                    <div id="previewContainer" class="hidden">
                        <div class="preview-wrapper relative bg-white rounded-lg overflow-hidden shadow-inner"
                             id="previewWrapper">
                            <img id="imagePreview" class="preview-image" alt="é¢„è§ˆ">

                            <!-- åˆ†å‰²çº¿å®¹å™¨ -->
                            <div id="splitLinesContainer" class="absolute inset-0 pointer-events-none"></div>

                            <!-- ç½‘æ ¼è¦†ç›–å±‚ -->
                            <div id="gridOverlay" class="grid-overlay"></div>
                        </div>

                        <!-- æ‰‹åŠ¨æ¨¡å¼æç¤º -->
                        <div id="manualModeHint" class="mt-3 text-sm text-amber-600 bg-amber-50 p-3 rounded-lg hidden">
                            <p class="font-medium">ğŸ’¡ æ‰‹åŠ¨è°ƒæ•´æ¨¡å¼</p>
                            <p class="text-xs mt-1 space-y-1">
                                <span class="inline-block px-2 py-0.5 bg-white rounded border border-amber-300 mr-1">ç‚¹å‡»</span>æ·»åŠ æ°´å¹³åˆ†å‰²çº¿
                                <span class="inline-block px-2 py-0.5 bg-white rounded border border-amber-300 mr-1 ml-2">Shift + ç‚¹å‡»</span>æ·»åŠ å‚ç›´åˆ†å‰²çº¿
                                <span class="inline-block px-2 py-0.5 bg-white rounded border border-amber-300 mr-1 ml-2">æ‹–åŠ¨</span>è°ƒæ•´ä½ç½®
                                <span class="inline-block px-2 py-0.5 bg-white rounded border border-amber-300 mr-1 ml-2">åŒå‡»</span>åˆ é™¤åˆ†å‰²çº¿
                            </p>
                        </div>
                    </div>

                    <!-- åŠ è½½åŠ¨ç”» -->
                    <div id="loading" class="hidden flex flex-col items-center justify-center h-80">
                        <div class="spinner mb-4"></div>
                        <p class="text-gray-600">æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
                    </div>
                </div>

                <!-- ç»“æœåŒºåŸŸ -->
                <div id="resultsSection" class="bg-gray-50 rounded-xl p-4 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-green-600">ğŸ‰ åˆ†å‰²ç»“æœ</h3>
                        <span id="resultCount" class="text-sm text-gray-500"></span>
                    </div>
                    <div id="resultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="toast hidden"></div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let originalImage = null;
        let splitImages = [];
        let imageFileName = '';
        let splitLines = {
            horizontal: [], // å­˜å‚¨æ°´å¹³çº¿çš„ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
            vertical: []    // å­˜å‚¨å‚ç›´çº¿çš„ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
        };
        let activeLine = null;
        let isDragging = false;

        // ==================== DOM å…ƒç´  ====================
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const splitBtn = document.getElementById('splitBtn');
        const resetBtn = document.getElementById('resetBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const previewContainer = document.getElementById('previewContainer');
        const previewWrapper = document.getElementById('previewWrapper');
        const imagePreview = document.getElementById('imagePreview');
        const splitLinesContainer = document.getElementById('splitLinesContainer');
        const gridOverlay = document.getElementById('gridOverlay');
        const emptyState = document.getElementById('emptyState');
        const loading = document.getElementById('loading');
        const resultsSection = document.getElementById('resultsSection');
        const resultsGrid = document.getElementById('resultsGrid');
        const imageInfo = document.getElementById('imageInfo');
        const manualModeHint = document.getElementById('manualModeHint');
        const gridSettings = document.getElementById('gridSettings');
        const qualityInput = document.getElementById('qualityInput');
        const qualityValue = document.getElementById('qualityValue');

        // ==================== äº‹ä»¶ç›‘å¬ ====================

        // æ–‡ä»¶ä¸Šä¼ 
        uploadSection.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) loadImage(e.target.files[0]);
        });

        // æ‹–æ‹½ä¸Šä¼ 
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                loadImage(file);
            } else {
                showToast('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'error');
            }
        });

        // åˆ†å‰²æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll('input[name="splitMode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'manual') {
                    gridSettings.classList.add('hidden');
                    manualModeHint.classList.remove('hidden');
                    splitLinesContainer.style.pointerEvents = 'auto';
                    enableManualMode();
                } else {
                    gridSettings.classList.remove('hidden');
                    manualModeHint.classList.add('hidden');
                    splitLinesContainer.style.pointerEvents = 'none';
                    disableManualMode();
                }
            });
        });

        // è¡Œåˆ—è¾“å…¥å˜åŒ–
        document.getElementById('rowsInput').addEventListener('input', updateGridPreview);
        document.getElementById('colsInput').addEventListener('input', updateGridPreview);

        // è´¨é‡æ»‘å—
        qualityInput.addEventListener('input', (e) => {
            qualityValue.textContent = e.target.value;
        });

        // æŒ‰é’®äº‹ä»¶
        splitBtn.addEventListener('click', splitImage);
        resetBtn.addEventListener('click', resetAll);
        downloadAllBtn.addEventListener('click', downloadAsZip);

        // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================

        /**
         * åŠ è½½å›¾ç‰‡
         */
        function loadImage(file) {
            imageFileName = file.name.replace(/\.[^/.]+$/, '');

            document.getElementById('infoFileName').textContent = file.name;
            document.getElementById('infoFileSize').textContent = formatFileSize(file.size);

            const reader = new FileReader();
            reader.onload = (e) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    document.getElementById('infoImageSize').textContent =
                        `${originalImage.width} Ã— ${originalImage.height}`;

                    imagePreview.src = e.target.result;
                    imagePreview.onload = () => {
                        emptyState.classList.add('hidden');
                        previewContainer.classList.remove('hidden');
                        imageInfo.classList.remove('hidden');
                        splitBtn.disabled = false;

                        // é‡ç½®åˆ†å‰²çº¿
                        splitLines = { horizontal: [], vertical: [] };
                        updateGridPreview();
                    };
                };
                originalImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        /**
         * æ›´æ–°ç½‘æ ¼é¢„è§ˆ
         */
        function updateGridPreview() {
            if (!originalImage) return;

            const mode = document.querySelector('input[name="splitMode"]:checked').value;
            if (mode === 'manual') return;

            const rows = parseInt(document.getElementById('rowsInput').value) || 2;
            const cols = parseInt(document.getElementById('colsInput').value) || 2;

            // æ¸…é™¤ç°æœ‰åˆ†å‰²çº¿
            splitLinesContainer.innerHTML = '';
            gridOverlay.innerHTML = '';

            // è®¡ç®—ç½‘æ ¼
            const cellWidth = 100 / cols;
            const cellHeight = 100 / rows;

            // ç»˜åˆ¶ç½‘æ ¼
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.style.left = `${col * cellWidth}%`;
                    cell.style.top = `${row * cellHeight}%`;
                    cell.style.width = `${cellWidth}%`;
                    cell.style.height = `${cellHeight}%`;
                    gridOverlay.appendChild(cell);
                }
            }
        }

        /**
         * å¯ç”¨æ‰‹åŠ¨æ¨¡å¼
         */
        function enableManualMode() {
            gridOverlay.innerHTML = '';
            splitLinesContainer.innerHTML = '';
        }

        /**
         * ç¦ç”¨æ‰‹åŠ¨æ¨¡å¼
         */
        function disableManualMode() {
            previewWrapper.removeEventListener('click', handlePreviewClick);
            updateGridPreview();
        }

        /**
         * å¤„ç†é¢„è§ˆåŒºåŸŸç‚¹å‡»ï¼ˆæ·»åŠ åˆ†å‰²çº¿ï¼‰
         */
        function handlePreviewClick(e) {
            if (e.target.closest('.split-line')) return;

            const rect = previewWrapper.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;

            // åˆ¤æ–­æ˜¯æ·»åŠ æ°´å¹³çº¿è¿˜æ˜¯å‚ç›´çº¿
            // Shift é”®æ·»åŠ å‚ç›´çº¿ï¼Œå¦åˆ™æ·»åŠ æ°´å¹³çº¿
            const isVertical = e.shiftKey;

            if (isVertical) {
                splitLines.vertical.push(xPercent);
                splitLines.vertical.sort((a, b) => a - b);
            } else {
                splitLines.horizontal.push(yPercent);
                splitLines.horizontal.sort((a, b) => a - b);
            }

            renderSplitLines();
        }

        // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
        previewWrapper.addEventListener('click', handlePreviewClick);

        /**
         * æ¸²æŸ“åˆ†å‰²çº¿
         */
        function renderSplitLines() {
            splitLinesContainer.innerHTML = '';

            // æ¸²æŸ“æ°´å¹³çº¿
            splitLines.horizontal.forEach((pos, index) => {
                const line = createSplitLine('horizontal', pos, index);
                splitLinesContainer.appendChild(line);
            });

            // æ¸²æŸ“å‚ç›´çº¿
            splitLines.vertical.forEach((pos, index) => {
                const line = createSplitLine('vertical', pos, index);
                splitLinesContainer.appendChild(line);
            });
        }

        /**
         * åˆ›å»ºåˆ†å‰²çº¿å…ƒç´ 
         */
        function createSplitLine(type, pos, index) {
            const line = document.createElement('div');
            line.className = `split-line ${type}`;
            line.dataset.type = type;
            line.dataset.index = index;

            if (type === 'horizontal') {
                line.style.top = `${pos}%`;
            } else {
                line.style.left = `${pos}%`;
            }

            // æ·»åŠ æ§åˆ¶ç‚¹
            const handle = document.createElement('div');
            handle.className = 'split-handle';
            line.appendChild(handle);

            // æ‹–åŠ¨äº‹ä»¶
            line.addEventListener('mousedown', startDrag);

            // åŒå‡»åˆ é™¤
            line.addEventListener('dblclick', () => {
                if (type === 'horizontal') {
                    splitLines.horizontal.splice(index, 1);
                } else {
                    splitLines.vertical.splice(index, 1);
                }
                renderSplitLines();
            });

            return line;
        }

        /**
         * å¼€å§‹æ‹–åŠ¨åˆ†å‰²çº¿
         */
        function startDrag(e) {
            e.preventDefault();
            e.stopPropagation(); // é˜²æ­¢è§¦å‘ç‚¹å‡»æ·»åŠ åˆ†å‰²çº¿
            isDragging = true;
            activeLine = e.target.closest('.split-line');
            activeLine.classList.add('active');

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        /**
         * æ‹–åŠ¨ä¸­
         */
        function onDrag(e) {
            if (!isDragging || !activeLine) return;

            const rect = previewWrapper.getBoundingClientRect();
            const type = activeLine.dataset.type;

            if (type === 'horizontal') {
                const y = e.clientY - rect.top;
                const pos = Math.max(0, Math.min(100, (y / rect.height) * 100));
                const index = parseInt(activeLine.dataset.index);
                splitLines.horizontal[index] = pos;
                activeLine.style.top = `${pos}%`;
            } else {
                const x = e.clientX - rect.left;
                const pos = Math.max(0, Math.min(100, (x / rect.width) * 100));
                const index = parseInt(activeLine.dataset.index);
                splitLines.vertical[index] = pos;
                activeLine.style.left = `${pos}%`;
            }
        }

        /**
         * åœæ­¢æ‹–åŠ¨
         */
        function stopDrag() {
            if (activeLine) {
                activeLine.classList.remove('active');
            }
            isDragging = false;
            activeLine = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        /**
         * åˆ†å‰²å›¾ç‰‡
         */
        function splitImage() {
            if (!originalImage) {
                showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
                return;
            }

            const mode = document.querySelector('input[name="splitMode"]:checked').value;
            let horizontalSplits, verticalSplits;

            if (mode === 'auto') {
                const rows = parseInt(document.getElementById('rowsInput').value) || 2;
                const cols = parseInt(document.getElementById('colsInput').value) || 2;

                // è‡ªåŠ¨ç”Ÿæˆå‡åŒ€åˆ†å‰²çº¿
                horizontalSplits = [];
                verticalSplits = [];

                for (let i = 1; i < rows; i++) {
                    horizontalSplits.push((i / rows) * 100);
                }
                for (let i = 1; i < cols; i++) {
                    verticalSplits.push((i / cols) * 100);
                }
            } else {
                // æ‰‹åŠ¨æ¨¡å¼
                horizontalSplits = [...splitLines.horizontal];
                verticalSplits = [...splitLines.vertical];

                if (horizontalSplits.length === 0 && verticalSplits.length === 0) {
                    showToast('è¯·å…ˆæ·»åŠ åˆ†å‰²çº¿', 'error');
                    return;
                }
            }

            // æ’åºåˆ†å‰²çº¿
            horizontalSplits.sort((a, b) => a - b);
            verticalSplits.sort((a, b) => a - b);

            const format = document.querySelector('input[name="format"]:checked').value;
            const quality = parseInt(qualityInput.value) / 100;

            loading.classList.remove('hidden');
            splitBtn.disabled = true;

            setTimeout(() => {
                try {
                    // è®¡ç®—åˆ†å‰²åŒºåŸŸ
                    const xSplits = [0, ...verticalSplits, 100];
                    const ySplits = [0, ...horizontalSplits, 100];

                    splitImages = [];
                    resultsGrid.innerHTML = '';

                    let processed = 0;
                    const total = (ySplits.length - 1) * (xSplits.length - 1);

                    for (let row = 0; row < ySplits.length - 1; row++) {
                        for (let col = 0; col < xSplits.length - 1; col++) {
                            const x1 = (xSplits[col] / 100) * originalImage.width;
                            const y1 = (ySplits[row] / 100) * originalImage.height;
                            const x2 = (xSplits[col + 1] / 100) * originalImage.width;
                            const y2 = (ySplits[row + 1] / 100) * originalImage.height;

                            const pieceWidth = x2 - x1;
                            const pieceHeight = y2 - y1;

                            const canvas = document.createElement('canvas');
                            canvas.width = pieceWidth;
                            canvas.height = pieceHeight;

                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(
                                originalImage,
                                x1, y1, pieceWidth, pieceHeight,
                                0, 0, pieceWidth, pieceHeight
                            );

                            canvas.toBlob((blob) => {
                                const url = URL.createObjectURL(blob);

                                splitImages.push({
                                    blob,
                                    url,
                                    row: row + 1,
                                    col: col + 1,
                                    width: Math.round(pieceWidth),
                                    height: Math.round(pieceHeight)
                                });

                                addResultItem(splitImages[splitImages.length - 1]);
                                processed++;

                                if (processed === total) {
                                    loading.classList.add('hidden');
                                    splitBtn.disabled = false;
                                    downloadAllBtn.disabled = false;
                                    resultsSection.classList.remove('hidden');
                                    document.getElementById('resultCount').textContent =
                                        `å…± ${total} å¼ å›¾ç‰‡`;
                                    showToast(`æˆåŠŸåˆ†å‰²ä¸º ${total} å¼ å›¾ç‰‡ï¼`);
                                }
                            }, `image/${format}`, quality);
                        }
                    }
                } catch (error) {
                    loading.classList.add('hidden');
                    splitBtn.disabled = false;
                    showToast('å›¾ç‰‡åˆ†å‰²å¤±è´¥ï¼š' + error.message, 'error');
                    console.error(error);
                }
            }, 100);
        }

        /**
         * æ·»åŠ ç»“æœé¡¹
         */
        function addResultItem(item) {
            const card = document.createElement('div');
            card.className = 'result-card bg-white rounded-lg p-2 shadow';
            card.innerHTML = `
                <img src="${item.url}" class="w-full h-24 object-contain rounded bg-gray-100 mb-2" alt="åˆ†å‰²å›¾ç‰‡">
                <div class="text-xs text-gray-600 space-y-0.5">
                    <div class="font-medium">è¡Œ${item.row} åˆ—${item.col}</div>
                    <div>${item.width} Ã— ${item.height}</div>
                    <div>${formatFileSize(item.blob.size)}</div>
                </div>
                <a href="${item.url}" download="${imageFileName}_row${item.row}_col${item.col}"
                   class="block w-full mt-2 bg-indigo-500 text-white text-center py-1.5 rounded text-sm hover:bg-indigo-600 transition-colors">
                    ä¸‹è½½
                </a>
            `;
            resultsGrid.appendChild(card);
        }

        /**
         * ä¸‹è½½ä¸º ZIP æ–‡ä»¶
         */
        async function downloadAsZip() {
            if (splitImages.length === 0) return;

            const zip = new JSZip();
            const format = document.querySelector('input[name="format"]:checked').value;

            // æ·»åŠ æ‰€æœ‰å›¾ç‰‡åˆ° ZIP
            splitImages.forEach((item) => {
                const ext = format === 'jpeg' ? 'jpg' : format;
                const filename = `${imageFileName}_row${item.row}_col${item.col}.${ext}`;
                zip.file(filename, item.blob);
            });

            // ç”Ÿæˆ ZIP æ–‡ä»¶
            try {
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${imageFileName}_split_images.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                URL.revokeObjectURL(url);
                showToast('ZIP æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼');
            } catch (error) {
                showToast('ZIP æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
                console.error(error);
            }
        }

        /**
         * é‡ç½®
         */
        function resetAll() {
            originalImage = null;
            splitImages = [];
            imageFileName = '';
            splitLines = { horizontal: [], vertical: [] };

            fileInput.value = '';
            document.getElementById('rowsInput').value = 2;
            document.getElementById('colsInput').value = 2;
            document.querySelector('input[name="format"][value="png"]').checked = true;
            qualityInput.value = 90;
            qualityValue.textContent = '90';

            emptyState.classList.remove('hidden');
            previewContainer.classList.add('hidden');
            imageInfo.classList.add('hidden');
            resultsSection.classList.add('hidden');
            resultsGrid.innerHTML = '';

            splitLinesContainer.innerHTML = '';
            gridOverlay.innerHTML = '';

            splitBtn.disabled = true;
            downloadAllBtn.disabled = true;

            showToast('å·²é‡ç½®');
        }

        /**
         * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        /**
         * æ˜¾ç¤ºæç¤º
         */
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast px-6 py-3 rounded-lg shadow-lg text-white font-medium ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
